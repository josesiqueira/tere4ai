version: 1
tasks:
  - description: |
      Update the AI HLEG preprocessing agent so that it systematically extracts
      RequirementSubtopics for **all seven** HLEG requirements, using the real
      heading patterns in ai_hleg.txt.

      The goal is:
        - Keep the same models and ingestion code.
        - Only change agent_hleg_preprocess.py instructions so the LLM:
            * detects subtopics from “catch phrases” like
              "Fundamental rights.", "Human oversight.", "Resilience to attack
              and security.", "Sustainable and environmentally friendly AI.",
              "Social impact.", "Society and Democracy.", "Auditability.",
              "Redress.", etc.
            * applies the same logic to all requirements (1.1–1.7), not just 1.6.
        - Subtopic.description must be grounded in the original text (verbatim
          or lightly cleaned), not invented.

      Do NOT add concurrency or change run_preprocess_ai_hleg.py – we will just
      re-run that script after updating the agent.
    changes:
      - path: agent_hleg_preprocess.py
        type: update
        content: |
          """
          AI HLEG Pre-processing Agent

          This module defines a PydanticAI agent that takes the raw text of the
          AI HLEG "Ethics Guidelines for Trustworthy AI" and extracts the
          seven requirements of Trustworthy AI in a structured form, including
          RequirementSubtopics under each requirement.

          TRUSTWORTHINESS PRINCIPLES:

            - The agent ONLY performs semantic extraction.
              It does NOT write to Neo4j or perform any side effects.

            - All deterministic metadata (document_id, source_file, year, etc.)
              is provided via HlegPreprocessDeps and MUST be echoed back exactly.

            - The set of requirements is CLOSED and CANONICAL:
              exactly seven requirements, with predefined IDs and names.
              The agent must not invent new requirements.

            - RequirementSubtopics are sub-sections or clearly separated themes
              under a single requirement (for ALL seven requirements).
              They are derived from the real textual structure in the guidelines:
                * small “catch phrase” headings like:
                    "Fundamental rights."
                    "Human oversight."
                    "Resilience to attack and security."
                    "Fallback plans and general safety."
                    "Accuracy, reliability and reproducibility."
                    "Privacy by design and by default."
                    "Data governance."
                    "Avoidance of unfair bias."
                    "Accessibility and universal design."
                    "Stakeholder participation."
                    "Sustainable and environmentally friendly AI."
                    "Social impact."
                    "Society and Democracy."
                    "Auditability."
                    "Minimisation and reporting of negative impacts."
                    "Trade-offs."
                    "Redress."
                * OR clear bullets / numbered list items that each express a
                  distinct theme.

              They are NOT new requirements; they refine ONE of the seven
              requirements.

            - The 'full_text' and all subtopic 'description' fields must be
              grounded in the original guidelines text (verbatim or lightly
              cleaned), not invented.
          """

          from dotenv import load_dotenv
          from pydantic_ai import Agent
          from pydantic_ai.models.openai import OpenAIChatModel

          from models.ai_hleg import HlegStructuredDoc
          from models.hleg_preprocess import HlegPreprocessDeps

          # Load environment variables from .env file (for OPENAI_API_KEY)
          load_dotenv()

          # Use GPT-5-nano for high-context, cost-effective preprocessing
          model = OpenAIChatModel(
              model_name="gpt-5-nano",
          )

          hleg_preprocess_agent = Agent[HlegPreprocessDeps, HlegStructuredDoc](
              model,
              deps_type=HlegPreprocessDeps,
              output_type=HlegStructuredDoc,
              instructions="""
          You are a preprocessing specialist for the AI HLEG 'Ethics Guidelines
          for Trustworthy AI'.

          Your task is to read the ENTIRE guidelines text and extract a
          structured representation of the SEVEN requirements of Trustworthy AI,
          plus RequirementSubtopics under each requirement when the text has a
          natural subdivision.

          INPUT:
            - Full plain text of the AI HLEG guidelines
            - Deterministic metadata via deps:
                * document_id (e.g. 'ai_hleg_2019')
                * source_file (e.g. 'data/ai_hleg.txt')
                * jurisdiction (e.g. 'EU')
                * instrument_type (e.g. 'Guidelines')
                * year (e.g. 2019)

          OUTPUT:
            - One HlegStructuredDoc with:
                * document_id, official_title, short_title, year
                * requirements: exactly SEVEN HlegRequirement objects
                  (each MUST have a 'subtopics' array; it may be empty in rare
                  cases, but in practice most requirements have several subtopics)

          -------------------------------------------------------------------
          1. METADATA HANDLING
          -------------------------------------------------------------------
          - Echo document_id, year, etc. exactly from deps.
          - Do NOT infer or change these values.
          - If the official title appears in the text, copy it faithfully into
            'official_title'. You may set 'short_title' to a concise variant
            like 'AI HLEG Ethics Guidelines'.

          -------------------------------------------------------------------
          2. CLOSED SET OF REQUIREMENTS (TOP LEVEL)
          -------------------------------------------------------------------
          The seven requirements of Trustworthy AI are:

            1) Human agency and oversight
            2) Technical robustness and safety
            3) Privacy and data governance
            4) Transparency
            5) Diversity, non-discrimination and fairness
            6) Societal and environmental well-being
            7) Accountability

          You MUST:
            - Extract exactly these seven requirements, no more, no less.
            - Use the following stable IDs for the 'id' field:

              - human_agency_and_oversight
              - technical_robustness_and_safety
              - privacy_and_data_governance
              - transparency
              - diversity_non_discrimination_and_fairness
              - societal_and_environmental_well_being
              - accountability

            - The 'name' field must match the official wording in the guidelines
              as closely as possible (minor punctuation differences are OK).

          -------------------------------------------------------------------
          3. SHORT_DESCRIPTION vs FULL_TEXT
          -------------------------------------------------------------------
          - short_description:
              * 1–3 sentences summarising the requirement.
              * Must be faithful to the guidelines and NOT speculative.
              * You may paraphrase as long as the meaning is preserved.

          - full_text:
              * Use a substantial excerpt from the main body text that introduces
                and explains the requirement (NOT the subtopics).
              * You may remove line breaks, bullets, and minor formatting, but
                must NOT invent content.

          -------------------------------------------------------------------
          4. REQUIREMENTSUBTOPICS FOR ALL REQUIREMENTS
          -------------------------------------------------------------------
          Goal: For EACH of the seven requirements, identify its internal
          themes/subsections and represent them as RequirementSubtopics.

          4.1 HOW TO IDENTIFY SUBTOPICS IN THE REAL DOCUMENT

          The HLEG guidelines follow a very regular pattern. Under each
          requirement, after an introductory paragraph, there are short
          “catch phrase” headings followed by explanation text.

          These look like:

            - 'Fundamental rights.' (under Human agency and oversight)
            - 'Human oversight.' (under Human agency and oversight)
            - 'Resilience to attack and security.' (under Technical robustness)
            - 'Fallback plans and general safety.'
            - 'Accuracy, reliability and reproducibility.'
            - 'Privacy by design and by default.'
            - 'Data governance.'
            - 'Avoidance of unfair bias.'
            - 'Accessibility and universal design.'
            - 'Stakeholder participation.'
            - 'Sustainable and environmentally friendly AI.'
            - 'Social impact.'
            - 'Society and Democracy.'
            - 'Auditability.'
            - 'Minimisation and reporting of negative impacts.'
            - 'Trade-offs.'
            - 'Redress.'
            - (and similar short phrases ending with a period)

          They have these properties:
            - They often appear at the start of a new line / paragraph.
            - They are SHORT (usually 2–8 words).
            - They end with a period '.'.
            - By themselves they are more like a LABEL or subtitle than a
              complete sentence; the explanation comes immediately after.

          YOUR HEURISTIC:

            - When you scan the text for a requirement section, treat any
              short phrase at the beginning of a line that:
                * starts with an uppercase letter,
                * consists of a few words,
                * ends with a period '.',
                * and is immediately followed by explanatory text,
              as a subtopic heading.

            - The subtopic.description should then be:
                * the paragraph(s) immediately*
